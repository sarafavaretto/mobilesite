<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="google-site-verification" content="Uj7KUjZeJk7udEvuMw2IARbnOyZEoQKfECcyyNqdJE8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Form elements - jQuery Mobile Demos</title>
		<link rel="stylesheet" href="./css/themes/default/jquery.mobile-1.4.5.min.css">
		<link rel="stylesheet" href="./assets/css/jqm.css">
		<link rel="shortcut icon" href="./favicon.ico">
		<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
		<script src="./js/jquery.js"></script>
		<script src="./assets/js/index.js"></script>
		<script src="./js/jquery.mobile-1.4.5.min.js"></script>
		
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
		<script type="text/javascript" src="https://apis.google.com/js/client.js"></script>
		<script type="text/javascript">
        function auth() {
	        var config = {
                'client_id': '293590021422-g899ro91b6hfg1tkg9q1f51tipekid90.apps.googleusercontent.com',
                'scope': 'https://www.googleapis.com/auth/fusiontables',
                'immediate': false
            };
            gapi.auth.authorize(config, function () {
                console.log('login complete');
                console.log(gapi.auth.getToken());
            });
        }
												
		$('#loginForm').submit(function(e) {
			e.preventDefault();
			var tableId = "1seiYS61e_U8ZBaZlBtcTsEFTp-MAv1WtJ-855z2t";
			var apiKey = "AIzaSyD8-PNgQ-IAE-scMuMV08McrQYtL2kIqq0";
			var sSql =  "SELECT%20*%20FROM%20"+ tableId +" where Username = '"+ $('#Username').val().toLowerCase() +"' and Password = '"+ $('#Password').val() +"'&key=" + apiKey;
			var queryurl = "https://www.googleapis.com/fusiontables/v1/query/?sql="+ sSql;

			$.getJSON( queryurl, function( data ) {
				if (data.rows == undefined){
					alert("Username o password errate");
					return false;
				}	
				else
				{
					alert("login avvenuto con successo");
					window.location.href = window.location.href + "?page=sceltaPanini&Nome="+ data.rows[0][3] + "&Cognome="+ data.rows[0][4] + "&Classe="+data.rows[0][5]
				}
			})

			return false;
		});

		$('#sceltaForm').submit(function(e) {
			auth();
			var d = new Date();
			var MM = (d.getMonth()+1).toString();
			var YY = (d.getFullYear()).toString();
			var dd = (d.getDay()).toString();
			var day = MM + "/" + dd + "/" + YY;
			gapi.client.setApiKey('AIzaSyD8-PNgQ-IAE-scMuMV08McrQYtL2kIqq0');
			gapi.client.load('fusiontables', 'v1', function () {                
				var query = "INSERT INTO 1pXmSJI53G1eS8eMBksdPF_f3QleXwnEbbQW0hGT6(CLASSE,NOME,COGNOME,SCELTA,DATA) " +
				" VALUES ('" + getData("Classe") + "','" + getData("Nome")+"', '"+ getData("Cognome")+"','"+ $('#listaMerende').find(":selected").text() + "','" + day + "')"; 
				gapi.client.fusiontables.query.sql({ sql: query }).execute(
				function (response) { console.log(response);
					alert("Dati inseriti correttamente");
					window.location.reload()
				});
				
			});

			return false;
		});

		//prende i dati passati in GET//
		function getData(requestName){
			if (requestName = (new RegExp('[?&]'+encodeURIComponent(requestName)+'=([^&]*)')).exec(location.search))
			return decodeURIComponent(requestName[1]);
		}


		//Funzione eseguite al caricamento della pagina//
		$(document).ready(function(){
			if (getData("page")=="sceltaPanini"){
				$("#login").css("display", "none");
			}
			else
			{
				$("#sceltaPanini").css("display", "none");
			}

			$("#nomeUtente").text("Utente: " + getData("Nome") + " " +getData("Cognome"));
			$("#Classe").text("Classe: " + getData("Classe"));
			caricaListaClasse();
		});
			

		function caricaListaClasse(){
			
			var tableId = "1pXmSJI53G1eS8eMBksdPF_f3QleXwnEbbQW0hGT6";
			var apiKey = "AIzaSyD8-PNgQ-IAE-scMuMV08McrQYtL2kIqq0";
			var sSql =  "SELECT%20*%20FROM%20"+ tableId +" where CLASSE = '"+ getData("Classe") +"'&key=" + apiKey;
			var queryurl = "https://www.googleapis.com/fusiontables/v1/query/?sql="+ sSql;

			$.getJSON( queryurl, function( data ) {
				if (data.rows == undefined){
					return false;
				}	
				else
				{
					var htmlList ="<table><tr>";
					var numCol = data.columns.length;
					for ( i= 0 ; i < numCol  ;i++){
						htmlList += "<td>"+ data.columns[i] + "</td>";
					}
					

					htmlList += "</tr>";
					
					for ( i= 0 ; i< data.rows.length ;i++){
						htmlList += "<tr>";
						for ( j= 0 ; j < numCol ;j++){

							htmlList += "<td>"+ data.rows[i][j] + "</td>";
						}	
						htmlList += "</tr>";
					}
					
					htmlList += "</table>"			
					$("#listDialog").find("a").before(htmlList) ;
				}
			})	

		}

		</script>



	</head>
	<body>
		<div data-role="page" class="jqm-demos" data-quicklinks="true">

			<div data-role="header" class="jqm-header">
				<h2><a href="./" title="jQuery Mobile Demos home"><img src="./assets/img/scaruffi.png" alt="jQuery Mobile"></a></h2>
				</div><!-- /header -->

			<div role="main"  class="ui-content jqm-content">
				<div id="login">
					<h1>Lista Panini</h1>

					<form id="loginForm" method="GET" action="./SceltaPanini.html">
		   
					
						<div data-demo-html="true">
							<label for="Username">Username:</label>
							<input type="text" required placeholder="Inserisci il tuo username" name="Username" id="Username" value="">

							<label for="Password">Password:</label>
							<input type="password" required name="Password" id="Password" value="" autocomplete="off">

							<button class="ui-shadow ui-btn ui-corner-all" >Login</button>
							<!--<button class="ui-shadow ui-btn ui-corner-all" onclick="window.location.href='./SceltaPanini.html?test=sara'" >Cambia Password</button>-->
							</div><!-- /demo-html -->

					</form>
				
				</div>
				<div id="sceltaPanini">
					<h1>Scelta Merende:</h1>
					<h3 id="nomeUtente"></h3>
					<h3 id="Classe"></h3>
					<form id="sceltaForm" method="POST" action="https://www.googleapis.com/fusiontables/v2/query/">
						<div data-demo-html="true">
							<div class="ui-field-contain">
								<label for="listaMerende">Merende:</label>
								<select required name="listaMerende" id="listaMerende">
									<option></option>
									<option value="1">Panino cotto</option>
									<option value="2">Panino crudo</option>
									<option value="3">Gnocco Salame</option>
									<option value="4">Gnocco prosciutto</option>
								</select>
							</div>
							<button class="ui-shadow ui-btn ui-corner-all" >Conferma</button>
							
						</div>
					</form>
					<a href="#popupDialog" 
						data-rel="popup"  data-position-to="window" data-transition="pop"
						class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-delete ui-btn-icon-left ui-btn-a">Lista Panini</a>
				</div>
			</div><!-- /page -->
	
			
		<div data-role="popup" id="popupDialog" data-overlay-theme="a" data-theme="a" data-dismissible="false" 
				style="max-width:400px;">
		    <div data-role="header" data-theme="a">
		    	<h1>Lista</h1>
		    </div>
		    <div id ="listDialog" role="main" class="ui-content">
		        <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Indietro</a>
		    </div>
		</div>
	</body>
</html>
